<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devdotdone.ddd.dao.UsersDao">
  <!-- 사용자 생성 -->
  <insert id="insertUser" parameterType="Users">
    <selectKey keyProperty="userId" resultType="int" order="BEFORE"> 
      select seq_users_user_id.nextval from dual 
    </selectKey> 
    INSERT INTO users ( user_id, userLoginId, userPassword, userName, userEmail, userIntro, userCreatedAt,ufAttachoname, ufAttachsname, ufAttachtype ,ufAttachdata ) 
    VALUES ( #{userId}, #{userLoginId}, #{userPassword}, #{userName}, #{userEmail}, #{userIntro}, SYSTIMESTAMP , #{ufAttachoname}, #{ufAttachsname}, #{ufAttachtype}, #{ufAttachdata} ) 
  </insert>

  <!-- 식별자 ID로 조회 -->
  <select id="selectUserById" resultType="Users" parameterType="int"> 
    SELECT * FROM users WHERE
    user_id= #{user_id} 
  </select>

  <!-- 로그인 ID로 조회 -->
  <select id="selectUserByLoginId" resultType="Users" parameterType="String"> 
    SELECT * FROM users
    WHERE userLoginId= #{userLoginId} 
  </select>

  <!-- 이메일로 조회 -->
  <select id="selectUserByEmail" resultType="Users" parameterType="String"> 
    SELECT * FROM users WHERE
    userEmail= #{userEmail} 
  </select>

  <!-- 전체 사용자 조회 -->
  <select id="selectAllUsers" resultType="Users"> 
    SELECT user_id, userLoginId, userPassword,
    userName, userEmail, userIntro,ufAttachoname, ufAttachsname, ufAttachtype ,ufAttachdata FROM
    users ORDER BY userCreatedAt desc 
  </select>

  <!-- 사용자 정보 수정 -->
  <update id="updateUser" parameterType="Users"> 
    UPDATE users SET userName = #{userName}, userEmail =
    #{userEmail}, userIntro = #{userIntro} 
    <if test="ufAttachoname !=null"> 
      ,ufAttachoname = #{ufAttachoname} 
      ,ufAttachsname = #{ufAttachsname} 
      ,ufAttachtype=#{ufAttachtype}
      ,ufAttachdata=#{ufAttachdata} 
    </if> WHERE user_id = #{userId} 
  </update>

  <!-- 사용자 삭제 -->
  <delete id="deleteUser" parameterType="int"> 
    DELETE FROM users WHERE user_id = #{userId} 
  </delete>

  <!-- 사용자 프로필 이미지 삭제 -->
  <update id="deleteUserProfileImg" parameterType="int"> UPDATE users SET ufAttachoname = NULL,
    ufAttachsname = NULL, ufAttachtype = NULL, ufAttachdata = NULL WHERE user_id = #{userId}
  </update>

  <!-- 이름 또는 이메일 일부로 사용자 검색 -->
  <select id="searchUsers" resultType="Users" parameterType="String">
    SELECT 
      user_id, userLoginId, userName, userEmail, userIntro, ufAttachoname, ufAttachsname, ufAttachtype, ufAttachdata
    FROM users
    WHERE userName LIKE '%' || #{keyword} || '%'
      OR userEmail LIKE '%' || #{keyword} || '%'
    ORDER BY userCreatedAt DESC
  </select>
</mapper>