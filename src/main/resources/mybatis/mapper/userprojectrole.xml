<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devdotdone.ddd.dao.UserProjectRoleDao">
  <!-- 프로젝트생성자-->
  <insert id="insertUsersProjectRole" parameterType="UserProjectRole">
    <selectKey resultType="int" keyProperty="uprId" order="BEFORE">
       SELECT seq_userprojectrole_uprid.NEXTVAL FROM dual
    </selectKey>

    insert into userProjectRole(
      upr_id, user_id, project_id, uprRole
    )
    values(#{uprId}, #{userId}, #{projectId},#{uprRole})
  </insert>

  <!-- 특정 프로젝트의 멤버 조회-->
  <select id="selectProjectMembers" parameterType="int" resultType="UserProjectRole">
    select upr_id, user_id, project_id, uprRole
    from userProjectRole
    where project_id=#{projectId}
    order by upr_id
  </select>

  <!-- 카운트 멤버수-->
  <select id="countProjectMembers" parameterType="int">
    select count(*) 
    from userProjectRole 
    where project_id=#{projectId} 
  </select>

  <!-- 특정 프로젝트의 관리자 수 찾기-->
  <select id="countProjectAdmins" parameterType="int">
    select count(*)
    from userProjectRole
    where project_id=#{projectId}
          and Upper(uprRole) ='ADMIN'

  </select>

  <!--특정 사용자의 프로젝트 역할 조회 -->
  <select id="selectUserProjectRole" parameterType="UserProjectRole" resultType="UserProjectRole">
    select uprRole
    from userProjectRole
    where project_id = #{projectId} AND user_id = #{userId}
  </select>

  <!-- 사용자 역할변경  -->
  <update id="updateUserProjectRole" parameterType="UserProjectRole">
        UPDATE userProjectRole 
        SET uprRole = #{uprRole}
        WHERE project_id = #{projectId} 
          AND user_id = #{userId}
  </update>

  <!--프로젝트에서 유저 제거-->
  <delete id="deleteUserProjectRole" parameterType="int">
    delete from userProjectRole
    where user_id=#{userId} and project_id=#{projectId}
  </delete>

  <!--프로젝트의 모든 유저 제거(프로젝트 삭제시 실행)-->
  <delete id="deleteAllUserProjectRole" parameterType="int">
    delete from userProjectRole
    where project_id=#{projectId}
  </delete>
</mapper>